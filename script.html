<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script>
        const obj = [
            "address",
            "avatar_url",
            "gender",
            "name",
            "nick_name",
            "note",
            "phone",
            "user_type",
            "message"];

        const buf = [];

        for (const key of obj) {
            //buf.push(`<custom-action id="field-${key}" head="课程描述" subhead="未配置"></custom-action>`)
            //buf.push(`const ${key.replaceAll(/_([a-z])/g,m=>m[1].toUpperCase())} = document.getElementById('field-${key}')`)
            //    buf.push(`
            //    if(obj.${key})
            //    ${key.replaceAll(/_([a-z])/g,m=>m[1].toUpperCase())}.setAttribute('subhead',obj.${key});`)


            buf.push(`
             ${key.replaceAll(/_([a-z])/g, m => m[1].toUpperCase())}.addEventListener('click', evt => {
             launchTextarea(obj ? obj.${key} : '', \`\${baseUri}/api/admin.user.update\`, data => {
                 return {
                     id,
                     ${key}: data
                 }
             }, (v) => {
                 if (id)
                     window.location.reload();
                 else if (v) {
                     window.location = \`\${window.location.origin}$\{window.location.pathname}?id=\${v}\`
                 }
             })
         })`);
            // buf.push(`${key}=coalesce(obj ->> '${key}', ${key}),`)
            //  buf.push(key)
        }
        // 
        console.log(buf.join('\n'))

    </script>

    <script>
      (()=>{
        const string = `func LessonCommentsQueryChildren(db *sql.DB, w http.ResponseWriter, r *http.Request) {
	crossOrigin(w)
	/*
		if !checkAdministratorPermission(db, r) {
			http.NotFound(w, r)
			return
		}
	*/
	q := r.URL.Query()
	id := q.Get("id")
	lessonId := q.Get("lessonId")
	queryJson(db, w, r, "select * from _lesson_comments_query_children($1,$2)", id, lessonId)
}
func AdminCheckLessons(db *sql.DB, w http.ResponseWriter, r *http.Request) {
	crossOrigin(w)
	/*
		if !checkAdministratorPermission(db, r) {
		http.NotFound(w, r)
		return
		}
	*/
	/*
			create or replace function _admin_check_lessons() returns integer
		    language plpgsql
		as
		$$
		declare
		    result_id int;
		    seconds   bigint;
		begin

		    select floor(extract(epoch from now())) into seconds;

		    update course
		    set hidden =2
		    where id in (
		        select course.id
		        from course
		                 join reservation r on course.id = r.course_id
		        where hidden = 0
		          and (seconds >= course.date_time + course.start_time - 3600)
		        group by course.id
		        having count(course.id) < 3
		    );
		    return result_id;
		end;
		$$;
	*/
	q := r.URL.Query()
	id := q.Get("id")
	queryJson(db, w, r, "select * from _admin_check_lessons($1)", id)
}`

        function toBlocks(string) {
            let count = 0;
            let buf = [];
            const blocks = [];
            for (let i = 0; i < string.length; i++) {
                buf.push(string[i])
                if (string[i] === '{') {
                    count++;
                } else if (string[i] === '}') {
                    count--;
                    if (count === 0) {
                        blocks.push(buf.join(''))
                        buf = [];
                    }
                }
            }
            console.log(blocks)
        }
        toBlocks(string)
      })()
    </script>
</body>

</html>